#!/usr/local/bin/node
const PATH=require('path');const FS=require('fs');const cheerio=require('cheerio');const HTMmin=require('html-minifier').minify;const SASS=require('node-sass');const LESS=require('less');const BABEL=require('babel-core');processTemplate=(a)=>new Promise((b,c)=>{a.target.template='',!a.src.template&&b(a),void 0,a.target.template=HTMmin(a.src.template,{removeComments:true,collapseWhitespace:true}),void 0,b(a)}),processStyle=(a)=>a.src.hasAttr('style','sass')?sass(a):less(a),sass=(a)=>new Promise((b,c)=>{void 0,a.target.style=SASS.renderSync({data:a.src.style,indentedSyntax:true,outputStyle:'compressed'}).css.toString(),void 0,b(a)}),less=(a)=>new Promise((b,c)=>{void 0,LESS.render(a.src.style,{compress:true}).then((d)=>{d.error&&c(d.error),a.target.style=d.css,void 0,b(a)},(a)=>{c(a)})}),processScript=(a)=>new Promise((b,c)=>{var d=a.target.template?`this.attachShadow({mode: 'open'}).appendChild(document.querySelector('template#${a.tagname}').content.cloneNode(true))`:'';var e=a.src.hasAttr('script','$')?`$(q){return this.shadowRoot.querySelector(q)}`:'';var f=a.src.hasAttr('script','$$')?`$$(q){return this.shadowRoot.querySelectorAll(q)}`:'';var g=a.src.hasAttr('script','ids')?`this.shadowRoot.querySelectorAll('[id]').forEach(node=>this[node.id]=node)`:'';var h=d||g?`constructor() {super();${d};${g};}`:'';a.target.script=`
window.customElements.define('${a.tagname}', class extends HTMLElement {
	${h}
	${e}
	${f}
 	${a.src.script}
});`,!a.src.hasAttr('script','dev')&&(a.target.script=BABEL.transform(a.target.script,{babelrc:false,comments:false,compact:false,minified:true,code:true,presets:['es2016'],plugins:['minify-mangle-names','minify-simplify','transform-remove-console']}).code),void 0,b(a)}),processLinks=(a)=>{a.target.links='',a.src.links.forEach((b)=>a.target.links+='//REQ:'+b),void 0},combineOutput=(a)=>new Promise((b,c)=>{a.target.content+=a.target.links;var d=a.target.style?`<style>${a.target.style}</style>`:'';a.target.content+=a.target.style||a.target.template?`document.head.insertAdjacentHTML('beforeend', \`<template id="${a.tagname}">${d}${a.target.template}</template>\`);`:'',a.target.content+=a.target.script,void 0,b(a)}),loadFile=(a)=>new Promise((b,c)=>{void 0,X={src:{},target:{}},X.src.filename=a,X.tagname=a.split('/').slice(-1)[0].replace('.tag.html',''),X.$=cheerio.load(FS.readFileSync(a,'utf-8')),X.src.hasAttr=(a,b)=>X.$(a).attr(b)!=undefined,X.src.template=X.$('template').html(),!X.src.template&&(X.src.template=''),X.src.script=X.$('script').text(),X.src.style=X.$('style').text(),X.src.links=[],X.$('link').map((a,b)=>X.src.links.push(''+X.$(b).attr('tag'))),b(X)}),saveFile=(a)=>new Promise((b,c)=>{var d=PATH.dirname(a.src.filename)+'/dist/';a.target.filename=d+a.tagname+'.tag.js',void 0;try{FS.mkdirSync(d)}catch(a){}FS.writeFileSync(a.target.filename,a.target.content,'utf-8')}),make=(a)=>{loadFile(a).then((a)=>processTemplate(a)).then((a)=>processStyle(a)).then((a)=>processScript(a)).then((a)=>processLinks(a)).then((a)=>combineOutput(a)).then((a)=>saveFile(a)).catch((a)=>void 0)};var watchPath=process.argv[2];!watchPath&&(void 0,process.exit(1)),void 0,FS.watch(watchPath,{recursive:true},(a,b)=>{!b.includes('.tag.html')||make(watchPath+b)});